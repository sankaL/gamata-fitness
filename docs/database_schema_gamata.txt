# GamataFitness Database Schema (Source of Truth)

Version: 3.0.0  
Last Updated: 2026-02-11

This document is the source of truth for the implemented Phase 2 schema.

## Version History

| Version | Date | Reason |
|---|---|---|
| 1.0.0 | 2026-02-08 | Initial draft schema |
| 2.0.0 | 2026-02-09 | Implemented Phase 2 schema, seed data, and RLS in Alembic |
| 2.1.0 | 2026-02-09 | Added user soft-deactivation columns and user filtering indexes for Phase 4 admin management |
| 3.0.0 | 2026-02-11 | Added workout prescription fields, cardio difficulty enum, and workout-plan archival columns for Phases 5 and 6 |

## Enums

- `user_role`: `admin`, `coach`, `user`
- `workout_type`: `strength`, `cardio`
- `cardio_difficulty_level`: `easy`, `medium`, `hard`
- `plan_assignment_status`: `pending`, `active`, `inactive`
- `session_type`: `assigned`, `swap`, `adhoc`

## Tables

### `users`
- `id` UUID PK, default `gen_random_uuid()`
- `name` VARCHAR(255), not null
- `email` VARCHAR(320), not null, unique
- `role` `user_role`, not null, default `user`
- `is_active` BOOLEAN, not null, default `true`
- `deactivated_at` TIMESTAMPTZ, nullable
- `created_at` TIMESTAMPTZ, not null, default `now()`
- `updated_at` TIMESTAMPTZ, not null, default `now()`

### `coach_user_assignments`
- `id` UUID PK, default `gen_random_uuid()`
- `coach_id` UUID FK -> `users.id`, not null
- `user_id` UUID FK -> `users.id`, not null
- `assigned_by` UUID FK -> `users.id`, not null
- `assigned_at` TIMESTAMPTZ, not null, default `now()`

Constraints:
- Unique: (`coach_id`, `user_id`)
- Check: `coach_id <> user_id`
- Trigger-enforced:
  - Coach must have role `coach`
  - Athlete must have role `user`
  - `assigned_by` must have role `admin`
  - Max 50 users per coach

### `muscle_groups`
- `id` UUID PK, default `gen_random_uuid()`
- `name` VARCHAR(120), not null, unique
- `icon` VARCHAR(120), not null
- `is_default` BOOLEAN, not null, default `true`
- `created_at` TIMESTAMPTZ, not null, default `now()`

### `cardio_types`
- `id` UUID PK, default `gen_random_uuid()`
- `name` VARCHAR(120), not null, unique
- `description` TEXT, not null

### `workouts`
- `id` UUID PK, default `gen_random_uuid()`
- `name` VARCHAR(160), not null, unique
- `description` TEXT, nullable
- `instructions` TEXT, nullable
- `type` `workout_type`, not null
- `cardio_type_id` UUID FK -> `cardio_types.id`, nullable
- `target_sets` SMALLINT, nullable
- `target_reps` SMALLINT, nullable
- `suggested_weight` NUMERIC(8,2), nullable
- `target_duration` INTEGER, nullable
- `difficulty_level` `cardio_difficulty_level`, nullable
- `is_archived` BOOLEAN, not null, default `false`
- `created_at` TIMESTAMPTZ, not null, default `now()`
- `updated_at` TIMESTAMPTZ, not null, default `now()`

Constraints:
- `target_sets > 0` when present
- `target_reps > 0` when present
- `suggested_weight >= 0` when present
- `target_duration > 0` when present
- Strength workouts require: `target_sets`, `target_reps`; and disallow cardio-only fields
- Cardio workouts require: `cardio_type_id`, `target_duration`, `difficulty_level`; and disallow strength-only fields

### `workout_muscle_groups`
- `workout_id` UUID FK -> `workouts.id`, not null
- `muscle_group_id` UUID FK -> `muscle_groups.id`, not null

Constraints:
- Primary Key: (`workout_id`, `muscle_group_id`)

### `workout_plans`
- `id` UUID PK, default `gen_random_uuid()`
- `name` VARCHAR(180), not null
- `coach_id` UUID FK -> `users.id`, not null
- `start_date` DATE, not null
- `end_date` DATE, not null
- `is_archived` BOOLEAN, not null, default `false`
- `archived_at` TIMESTAMPTZ, nullable
- `created_at` TIMESTAMPTZ, not null, default `now()`
- `updated_at` TIMESTAMPTZ, not null, default `now()`

Constraints:
- Check: `start_date <= end_date`

### `plan_days`
- `id` UUID PK, default `gen_random_uuid()`
- `plan_id` UUID FK -> `workout_plans.id`, not null
- `day_of_week` SMALLINT, not null

Constraints:
- Check: `day_of_week >= 0 AND day_of_week <= 6`
- Mapping: Monday=`0`, Tuesday=`1`, Wednesday=`2`, Thursday=`3`, Friday=`4`, Saturday=`5`, Sunday=`6`
- Unique: (`plan_id`, `day_of_week`)

### `plan_day_workouts`
- `plan_day_id` UUID FK -> `plan_days.id`, not null
- `workout_id` UUID FK -> `workouts.id`, not null

Constraints:
- Primary Key: (`plan_day_id`, `workout_id`)

### `plan_assignments`
- `id` UUID PK, default `gen_random_uuid()`
- `plan_id` UUID FK -> `workout_plans.id`, not null
- `user_id` UUID FK -> `users.id`, not null
- `status` `plan_assignment_status`, not null, default `pending`
- `assigned_at` TIMESTAMPTZ, not null, default `now()`
- `activated_at` TIMESTAMPTZ, nullable
- `deactivated_at` TIMESTAMPTZ, nullable

Constraints:
- Partial unique index on `user_id` where status = `active` (single active plan per user)

### `workout_sessions`
- `id` UUID PK, default `gen_random_uuid()`
- `user_id` UUID FK -> `users.id`, not null
- `workout_id` UUID FK -> `workouts.id`, not null
- `plan_id` UUID FK -> `workout_plans.id`, nullable
- `session_type` `session_type`, not null, default `assigned`
- `completed_at` TIMESTAMPTZ, nullable
- `updated_at` TIMESTAMPTZ, not null, default `now()`

### `exercise_logs`
- `id` UUID PK, default `gen_random_uuid()`
- `session_id` UUID FK -> `workout_sessions.id`, not null
- `sets` INTEGER, nullable
- `reps` INTEGER, nullable
- `weight` NUMERIC(8,2), nullable
- `duration` INTEGER, nullable
- `notes` TEXT, nullable
- `logged_at` TIMESTAMPTZ, not null, default `now()`
- `updated_at` TIMESTAMPTZ, not null, default `now()`

Constraints:
- `sets`, `reps`, `weight`, `duration` are non-negative when present

## Indexes

- `ix_coach_user_assignments_coach_id`
- `ix_coach_user_assignments_user_id`
- `ix_users_role`
- `ix_users_is_active`
- `ix_workouts_type`
- `ix_workouts_is_archived`
- `ix_workout_plans_coach_id`
- `ix_workout_plans_is_archived`
- `ix_plan_days_plan_id`
- `ix_plan_assignments_plan_id`
- `ix_plan_assignments_user_id`
- `ix_plan_assignments_status`
- `ix_workout_sessions_user_id`
- `ix_workout_sessions_workout_id`
- `ix_workout_sessions_plan_id`
- `ix_workout_sessions_user_completed_at`
- `ix_exercise_logs_session_id`
- `ix_exercise_logs_session_logged_at`
- `uq_plan_assignments_user_active` (partial unique)

## Timestamp Trigger

`public.set_updated_at()` is attached to:
- `users`
- `workouts`
- `workout_plans`
- `workout_sessions`
- `exercise_logs`

## Seed Data (Phase 2)

### Muscle Groups (7)
- Chest
- Back
- Legs
- Shoulders
- Arms
- Core
- Full-Body

### Cardio Types (4)
- HIIT
- Steady State
- Interval
- Circuit

### Workout Library (24)
- Bench Press
- Incline Dumbbell Press
- Push-Up
- Bent-Over Row
- Pull-Up
- Deadlift
- Back Squat
- Walking Lunge
- Leg Press
- Overhead Press
- Lateral Raise
- Biceps Curl
- Triceps Dip
- Plank Hold
- Russian Twist
- Glute Bridge
- Treadmill Run
- Indoor Cycling
- Rowing Machine Intervals
- Jump Rope
- Stair Climber
- Elliptical Trainer
- HIIT Circuit
- Brisk Walk

## RLS Summary

RLS is enabled for all Phase 2 tables with policy goals:
- Users can access their own user record, plan assignments, sessions, and logs.
- Coaches can access data for assigned users.
- Admins can manage all records.
- Lookup tables (`muscle_groups`, `cardio_types`, `workouts`) are readable by authenticated users and writable by admins.

Policy implementation and helper functions are in:
- `database/migrations/sql/202602090003_phase2_rls_up.sql`

## Alembic Revisions (Phase 2)

- `202602090001_phase2_schema.py`: tables, enums, constraints, indexes, triggers
- `202602090002_phase2_seed_data.py`: default muscle groups, cardio types, workout library
- `202602090003_phase2_rls_policies.py`: RLS helper functions and policies
- `202602090004_phase4_user_deactivation.py`: `users.is_active`, `users.deactivated_at`, and supporting user list indexes
- `202602110001_phase56_schema_expansion.py`: cardio difficulty enum, workout target fields, workout field constraints, and plan archive columns/index
